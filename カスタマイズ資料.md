# カスタマイズ資料　兼チラシの裏
複数バリアントに対応するしくみが未実装のため、データ仕様は今後変わると思う

- pyファイルの構成

| ファイル名 | 概要 |
| ---- | ---- |
| era2webui.py | 実行用のファイル。savフォルダを監視し、txtの更新を検知してあれこれ呼び出す。|
| sub.py | バリアントによらない共通の関数を記述。ブラウザ操作はここ。|
| suberaXXXX.py | XXXXにバリアントを表す記号が入る。バリアントにより違いの出る関数を記述。プロンプト生成はここ。|
| emo.py | プロンプト生成処理のうち、感情表現だけ切り出したもの。なんとなく。|
| imageviewer.py | 画像表示用のウィンドウを表示する機能。pngファイルの新規作成を監視する。|


- emuera側の動作
   - TEXTLOG.ERB に記述した**OUTPUT_TXT**関数がほぼ全ての処理を行う。他のERB改変は**CALL OUTPUT_TXT("シーン名称")**をあちこちに記述しているだけ。
   - **OUTPUT_TXT**関数はキャラクター情報や選択したコマンド等をjson文字列にまとめ、savフォルダにtxtファイルで出力する。
   - 200ミリ秒未満の連続呼び出しは無視する。
   - txtファイルは0～4までの連番つきで出力し、5回出力するまで上書きしないことで、読み取りの猶予時間を作っている。


## csv編集について
csvは画像生成の度に読み込む。編集して上書き保存すると即時反映される

## Train.csv
コマンドに対応するプロンプトを記述するファイル  
Eraが吐き出した**コマンド番号**に対応したプロンプトが読み込まれる。コマンド名は飾り。

| 列ラベル | 概要 |
| ---- | ---- |
| プロンプト| 記入した文字列をプロンプトに渡す<br>空欄にすると特殊処理として、汎用調教プロンプト(Event.csvに記述)を呼び出す|
| ネガティブ| 記入した文字列をネガティブプロンプトに渡す|
| 解像度| 「512x768」などと記入すると出力時に解像度を変更する。（解像度自動変更機能をONにしている場合。）<BR>初期設定では%縦長%などと置換機能を利用した書き方をしている。詳細は後述。|
| 拒否プロンプト| 実行に判定のあるコマンドに失敗したときに読み出される。<br> **判定のないコマンドでは空欄にしておかないと誤動作する。**|
| 拒否ネガティブ| 略|
| キャラ描画 | プロンプトにキャラクターの記述を含めるかどうかのフラグ。1か0を入れる。|
| 顔描画 | プロンプトに表情の記述を含めるかどうかのフラグ。1か0を入れる。|
| 胸描画 | プロンプトに胸サイズなどの記述を含めるかどうかのフラグ。1か0を入れる。<br>1にすると構図に無理やり胸をねじ込まれることがあるので注意。以下同様|
| ヴァギナ描画 | プロンプトにバイブや愛液等の記述を含めるかどうかのフラグ。1か0を入れる。<br>**1にしなくても局部の描画はされる。**|
| アナル描画 | プロンプトにアナルバイブ等の記述を含めるかどうかのフラグ。1か0を入れる。|
| アナル描画 | プロンプトにアナルバイブ等の記述を含めるかどうかのフラグ。1か0を入れる。|

## ReplaceList.csv (置換機能)
置換機能による置換前と置換後の文字列を書くファイル。
プロンプト・ネガティブ文字列および解像度欄で置換機能が有効。  
**%で囲まれた文字列**を置換用の記号として解釈し、ReplaceList.csvに基づいて置換する。  
置換処理はプロンプト文字列が完成してブラウザに渡す直前に行う。一度にいくつでも置換できるが、一度置換したものを再び置換はしない。  
%で囲まれた文字列があり、ReplaceList.csvに記述がない場合、Errorという文字列に置換される。  
プロンプトに%なんて誰も使わんやろーと思っているが問題がありそうなら他の記号にします。  
既知の不具合:プロンプトの最初に Ichigo100%、最後の方にToguro100% があったりすると、ごっそり消失してIchigo100Errorだけが残る。あとで直さねば

## Charactor.csv
キャラクターに対応するプロンプトを記述するファイル。  
キャラ描画フラグが1の場面で読み出される。  
Eraが吐き出した**CALLNAME**が**キャラ名列**に一致する行のプロンプトが読み込まれる。キャラ番号はいまのところは飾り。  
CALLNAMEって口上で変化しそう。問題になるようなら修正する。
| 列ラベル | 概要 |
| ---- | ---- |
|プロンプト、<br>ネガティブ|略|
| 目の色 | red,yellowなど色名だけを書く。red eyesのようにプロンプトに記述される。(closedEyesフラグが1のときはスキップ)<br>学習が十分なキャラでは空欄にすることを推奨。色名は服や髪等への色写りのリスクがあるのでなるべく記述したくない。モデルが学習しているキャラクターならあえて記述しなくてもだいたい正解してくれるし、髪色と違いたまに間違って描かれてもそれほど困らない。よほど違和感が強い間違いが多いときには記述する|

## Add_charactor.csv
カスタマイズキャラクターを追加するために用意したファイル。  
Charactor.csvと内部的に結合して読み込まれる。Charactor.csvに書き込むのと同じ結果になるので別になくてもいいファイル。
- キャラクター強制変更機能
  - 拾ってきたキャラクターLoraを試用したりするのに使う機能
  - キャラ名が「描画キャラ上書き」の行にプロンプトを記入すると、本来のキャラクタープロンプトに置き買わる。

## Event.csv
Train以外のシーン描写を記述するファイル。  
Train同様、構図決定に必要なフラグを設定する。  
***ERB中にCALL OUTPUT_TXT("シーン名称")を記述し、このcsvの名称列に同じシーン名称を書いてプロンプトを記述すれば1つの画像表示シーンのできあがり。***
| 列ラベル | 概要 |
| ---- | ---- |
|プロンプトや各描画フラグ|Trainと同じ|
|主人以外が相手|主人公以外を相手に何かしらするときのフラグ。1を入れると、恋慕や反発刻印の表情への影響が出なくなる。<br>ちなみに調教中に助手に交代しているときも同じ処理をしている。|

## Efferct.csv
各種エフェクトのプロンプトを記入するファイル。射精エフェクトや絶頂エフェクトなど。  
Event.csvと違って構図情報を含まない。  
いまのところプログラム中にプロンプトを直書きしているエフェクトの方が多い。  
条件分岐と一緒にハードに書いちゃった方が可読性がいいので悩みどころ。
- ***基礎プロンプト***
  - すべての生成に無条件で付加するプロンプトとネガティブを記述する。
- ***人物プロンプト***
  - キャラ描画ありのときのすべての生成に付加するプロンプトとネガティブを記述する。

## Equip.csv
装備品のプロンプトを記入するファイル。TEQUIPフラグと値の2次元のキーをもつ。  
eraからtxt出力するとき、値が0でないTEQUIPフラグはすべて書き出している。  
書き出したTEQUIPと値でcsvを捜査して一致する行のプロンプトを読み出す。  
全て書き出ししていることにより、よく未定義の装備を捜査してエラーを吐いてる。  
バイブ・アナルバイブは、装備していても描画フラグがONのときしか描写しない。(プロンプトの効きが悪くてフラグONでもあまり描かれなかったりする)  

## Location.csv
場所に対応するプロンプトを書くファイル。  
場所移動のあるバリアントに対応した暁には場所IDとプロンプトの対応を書くファイルになると思う。  
YMの場合はpyのプログラムで場所判別して呼び出しており、Effect.csvとやってることは変わらない。
  
## 解像度指定の記法について
"x"(小文字のエックス)で分割された2つの整数を書くと横×縦の解像度として認識する。認識できない場合は解像度変更をスキップする。(前回出力が縦長なら縦長、横長なら横長)  
"X","*","×"でも認識するようにした。  
解像度の列に限定の特殊処理として、カンマで区切った複数の解像度を入力するとランダム選択として解釈する。構図が限定されない方がたのしい場合に使う。例:「512x512,512x640,512x768」で3択。  
解像度指定欄は%で囲うことによる置換機能に対応している（前述）。「%正方形%,%縦長%」のような指定も可。  
処理の順序は「%による置換」>「カンマによるランダム選択」>「xによる分割」の順

## やりたいこととか妄想
- 表情コントロールの作り直し
  - 表情の足し算を重ねすぎてひたすらプロンプトが長い
  - パラメータごとに感情強度を設定して強度が相対的に低い感情は捨てるようにするとか
  - 性格やらパラメータやらで多次元の表を作ってマス目を埋めるように全パターン個別に書くとか
- 口上に先んじた画像表示（上昇パラメータの先取り）
  - これやるとバリアントが変わる毎の作業量が跳ね上がりそう
- Add_charactor.csvにガーッと書いたキャラをウワーッと店頭に並べるプログラム
- 脱衣のコントロール　YM意外だと当たり前にあるけど服装をちゃんと記述するとなるとキャラシートが面倒。一度全員shirtとskirtでやってみるか
- csvでプロンプトの分岐を増やす書き方を考える。陥落や慣れで構図から変えられるように
- 表示した画像上にポップアップ画像を重ねる。あらかじめ用意した書き文字とかカットイン的なの
- ひな形画像を用意してControlNetに渡す
- プロンプトでスペルカード再現しようとするの楽しい
- 出せない構図とかキャラの再現性とかはそのうち技術的ブレイクスルーがあるんじゃないかのう
